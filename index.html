<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viennoiserie Dough & Lamination Calculator</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.5;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        h1 { text-align: center; margin-bottom: 20px; font-size: 24px; }
        h2 { font-size: 20px; margin-bottom: 15px; }
        h3 { font-size: 18px; margin-bottom: 10px; }
        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (min-width: 768px) { .grid { grid-template-columns: 1fr 1fr; } }
        .panel { padding: 15px; border-radius: 8px; }
        .input-panel { background-color: #f9f9f9; }
        .recipe-panel { background-color: #e6f2ff; }
        .mass-panel { background-color: #e8f5e9; }
        .cost-panel { background-color: #fce4ec; }
        .instruction-panel { background-color: #fff9e6; padding: 15px; border-radius: 8px; }
        .form-group { margin-bottom: 8px; }
        label { display: block; font-weight: 500; margin-bottom: 5px; font-size: 14px; }
        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        input[type="range"] { width: 50%; margin: 5px 0; }
        .range-labels { display: flex; justify-content: space-between; font-size: 12px; color: #666; width: 50%; }
        .radio-group { display: flex; gap: 15px; margin-bottom: 10px; }
        .radio-label { display: flex; align-items: center; }
        .checkbox-label { display: flex; align-items: center; user-select: none; }
        input[type="radio"], input[type="checkbox"] { margin-right: 5px; }
        select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        td:last-child { text-align: right; font-weight: 500; }
        .note { background-color: #fffde7; border: 1px solid #fff9c4; border-radius: 4px; padding: 10px; font-size: 13px; margin: 10px 0; }
        .alert { color: #d32f2f; font-size: 12px; margin-left: 5px; }
        .info-text { font-size: 12px; color: #666; margin-left: 5px; }
        ol { padding-left: 20px; margin-top: 10px; }
        li { margin-bottom: 8px; }
        .summary { margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd; }
        .total-weight { display: flex; justify-content: space-between; font-weight: bold; margin-top: 5px; }
        .info-box { background-color: #e3f2fd; border: 1px solid #bbdefb; border-radius: 4px; padding: 10px; margin: 10px 0; font-size: 13px; }
        .info-list { padding-left: 20px; margin: 5px 0; }
        canvas { border: 1px solid #ddd; margin-top: 10px; width: 100%; max-height: 150px; }
        .panel-split { display: flex; gap: 20px; }
        .panel-left, .panel-right { flex: 1; }
        .cost-grid {
            display: grid;
            grid-template-columns: 120px 80px 120px 80px;
            gap: 10px;
            margin-bottom: 15px;
            padding: 0 10px;
        }
        .cost-grid label {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #waterCost, #sugarCost, #yeastCost,
        label[for="waterCost"], label[for="sugarCost"], label[for="yeastCost"] {
            margin-left: 40px;
        }
        .other-ingredient { display: flex; gap: 5px; margin-bottom: 8px; }
        .other-ingredient input[type="text"] { width: 100px; }
        .other-ingredient input[type="number"] { width: 60px; }
        .other-ingredient button { width: 60px; padding: 5px; }
        button { padding: 5px 10px; border: 1px solid #ccc; border-radius: 4px; background-color: #f0f0f0; cursor: pointer; }
        button:hover { background-color: #e0e0e0; }
        input[disabled] { background-color: #eee; border: none; color: #333; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Viennoiserie Dough & Lamination Calculator</h1>
        
        <div class="grid">
            <div class="panel input-panel">
                <h2>Dough Settings</h2>
                
                <div class="form-group">
                    <label for="pastryCount">Number of Pastries</label>
                    <input type="number" id="pastryCount" min="1" value="12">
                </div>
                
                <div class="form-group">
                    <label for="pastryWeight">Pastry Weight (g)</label>
                    <input type="number" id="pastryWeight" min="20" value="80">
                    <label class="checkbox-label">
                        <input type="checkbox" id="useMassCalculator" checked>
                        Use Mass Calculator
                    </label>
                </div>
                
                <div class="form-group">
                    <label for="hydration">Hydration: <span id="hydrationValue">54</span>%</label>
                    <input type="range" id="hydration" min="50" max="60" step="1" value="54">
                    <div class="range-labels">
                        <span>50%</span>
                        <span>60%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="usePoolish">
                        Use Poolish (15% pre-ferment)
                    </label>
                </div>
                
                <div class="form-group">
                    <label for="cutoffsWeight">Cutoffs from Previous Batch (g)</label>
                    <input type="number" id="cutoffsWeight" min="0" value="0">
                </div>
                
                <h3>Recipe Proportions</h3>
                
                <div class="form-group">
                    <label for="salt">Salt (% of flour): <span id="saltValue">2</span>%</label>
                    <input type="range" id="salt" min="1" max="3" step="0.1" value="2">
                </div>
                
                <div class="form-group">
                    <label for="sugar">Sugar (% of flour): <span id="sugarValue">10</span>%</label>
                    <input type="range" id="sugar" min="5" max="15" step="1" value="10">
                </div>
                
                <div class="form-group">
                    <label for="butter">Butter in Dough (% of flour): <span id="butterValue">9</span>%</label>
                    <input type="range" id="butter" min="5" max="20" step="1" value="9">
                </div>
                
                <div class="form-group">
                    <label>Yeast Type</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="yeastType" value="fresh" checked>
                            Fresh
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="yeastType" value="instant">
                            Instant Dry
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="yeastType" value="active">
                            Active Dry
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="yeast">
                        <span id="yeastTypeLabel">Fresh</span> Yeast (% of flour): <span id="yeastValue">3</span>%
                        <span id="yeastEquivalent" class="info-text">(Equivalent to 0.9% instant or 1.5% active dry)</span>
                    </label>
                    <input type="range" id="yeast" min="1" max="5" step="0.1" value="3">
                </div>
                
                <h3>Lamination Settings</h3>
                
                <div class="form-group">
                    <label for="laminationButter">Lamination Butter (% of dough): <span id="laminationButterValue">33</span>%</label>
                    <input type="range" id="laminationButter" min="20" max="35" step="1" value="33">
                </div>
                
                <div class="form-group">
                    <label for="fold1">Fold 1</label>
                    <select id="fold1">
                        <option value="none">None</option>
                        <option value="single">Single (5 layers)</option>
                        <option value="letter" selected>Letter (7 layers)</option>
                        <option value="book">Book (9 layers)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="fold2">Fold 2</label>
                    <select id="fold2">
                        <option value="none">None</option>
                        <option value="single">Single (~2x prior layers)</option>
                        <option value="letter">Letter (~3x prior layers)</option>
                        <option value="book">Book (~4x prior layers)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="fold3">Fold 3</label>
                    <select id="fold3">
                        <option value="none">None</option>
                        <option value="single">Single (~2x prior layers)</option>
                        <option value="letter">Letter (~3x prior layers)</option>
                        <option value="book">Book (~4x prior layers)</option>
                    </select>
                </div>
            </div>
            
            <div class="panel recipe-panel">
                <h2>Viennoiserie Recipe</h2>
                
                <div>
                    <h3>Main Dough</h3>
                    <table>
                        <tbody>
                            <tr>
                                <td>Flour</td>
                                <td id="flourAmount">0 g</td>
                            </tr>
                            <tr>
                                <td>Water</td>
                                <td id="waterAmount">0 g</td>
                            </tr>
                            <tr>
                                <td>Salt</td>
                                <td id="saltAmount">0 g</td>
                            </tr>
                            <tr>
                                <td>Sugar</td>
                                <td id="sugarAmount">0 g</td>
                            </tr>
                            <tr>
                                <td>Butter (for dough)</td>
                                <td id="butterAmount">0 g</td>
                            </tr>
                            <tr>
                                <td id="yeastTypeDisplay">Fresh Yeast</td>
                                <td id="yeastAmount">0 g</td>
                            </tr>
                            <tr id="cutoffsRow" style="display: none;">
                                <td>Cutoffs</td>
                                <td id="cutoffsAmount">0 g</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div id="poolishSection" style="display: none;">
                    <h3>Poolish (Make ahead)</h3>
                    <table>
                        <tbody>
                            <tr>
                                <td>Flour</td>
                                <td id="poolishFlourAmount">0 g</td>
                            </tr>
                            <tr>
                                <td>Water</td>
                                <td id="poolishWaterAmount">0 g</td>
                            </tr>
                            <tr>
                                <td id="poolishYeastTypeDisplay">Fresh Yeast</td>
                                <td>
                                    <span id="poolishYeastAmount">0 g</span>
                                    <span id="precisionScaleWarning" class="alert" style="display: none;">(Use precision scale)</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="note">
                        <p>Prepare poolish 12-16 hours ahead for slow fermentation.</p>
                    </div>
                </div>
                
                <div>
                    <h3>Lamination</h3>
                    <table>
                        <tbody>
                            <tr>
                                <td>Butter (for lamination)</td>
                                <td id="laminationButterAmount">0 g</td>
                            </tr>
                            <tr>
                                <td>Total Layers</td>
                                <td id="totalLayers">0</td>
                            </tr>
                        </tbody>
                    </table>
                    <canvas id="layerVisualization" width="300" height="100"></canvas>
                </div>
                
                <div class="summary">
                    <div class="total-weight">
                        <span>Total Dough Weight:</span>
                        <span id="totalDoughWeight">0 g</span>
                    </div>
                    <div class="total-weight">
                        <span>Expected Final Weight:</span>
                        <span id="finalWeight">0 g</span>
                    </div>
                    <div class="total-weight">
                        <span>Total Batch Cost:</span>
                        <span id="totalCost">£0.00</span>
                    </div>
                    <div class="total-weight">
                        <span>Cost per Pastry:</span>
                        <span id="costPerPastry">£0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 14px; margin-top: 10px;">
                        <span>Pastries:</span>
                        <span id="pastrySummary">12 × 80g each</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel mass-panel">
            <h2>Mass Calculator</h2>
            <div class="panel-split">
                <div class="panel-left">
                    <div class="form-group">
                        <label>Shape</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="shape" value="triangle" checked>
                                Triangle (Croissant)
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="shape" value="rectangle">
                                Rectangle (Danish, etc.)
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="thickness">Thickness: <span id="thicknessValue">4</span> mm</label>
                        <input type="range" id="thickness" min="3" max="6" step="0.5" value="4">
                        <div class="range-labels">
                            <span>3 mm</span>
                            <span>6 mm</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="length">Length: <span id="lengthValue">25</span> cm</label>
                        <input type="range" id="length" min="5" max="50" step="1" value="25">
                        <div class="range-labels">
                            <span>5 cm</span>
                            <span>50 cm</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="width">Width: <span id="widthValue">9</span> cm</label>
                        <input type="range" id="width" min="2" max="20" step="0.5" value="9">
                        <div class="range-labels">
                            <span>2 cm</span>
                            <span>20 cm</span>
                        </div>
                    </div>
                </div>
                <div class="panel-right">
                    <div class="summary">
                        <div class="total-weight">
                            <span>Raw Dough Mass:</span>
                            <span id="rawMass">0 g</span>
                        </div>
                        <div class="total-weight">
                            <span>Post-Bake Mass (est.):</span>
                            <span id="bakedMass">0 g</span>
                        </div>
                        <div class="total-weight">
                            <span>Estimated Density:</span>
                            <span id="density">0 g/cm³</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel cost-panel">
            <h2>Cost Calculator</h2>
            <div class="cost-grid">
                <label for="flourCost">Flour (£/kg)</label>
                <input type="number" id="flourCost" min="0" step="0.01" value="0.50">
                <label for="waterCost">Water (£/kg)</label>
                <input type="number" id="waterCost" min="0" step="0.01" value="0.00">
                <label for="saltCost">Salt (£/kg)</label>
                <input type="number" id="saltCost" min="0" step="0.01" value="0.40">
                <label for="sugarCost">Sugar (£/kg)</label>
                <input type="number" id="sugarCost" min="0" step="0.01" value="0.80">
                <label for="butterCost">Butter (£/kg)</label>
                <input type="number" id="butterCost" min="0" step="0.01" value="3.50">
                <label for="yeastCost">Yeast (£/kg)</label>
                <input type="number" id="yeastCost" min="0" step="0.01" value="1.60">
            </div>
            <h3>Other Ingredients</h3>
            <div id="otherIngredients"></div>
            <button id="addOther">Add Ingredient</button>
            <div class="summary">
                <div class="total-weight">
                    <span>Core Ingredients Cost:</span>
                    <span id="coreCost">£0.00</span>
                </div>
                <div class="total-weight">
                    <span>Other Ingredients Cost:</span>
                    <span id="otherIngredientsCost">£0.00</span>
                </div>
                <div class="total-weight">
                    <span>Total Batch Cost:</span>
                    <span id="totalCostLocal">£0.00</span>
                </div>
            </div>
        </div>
        
        <div class="panel instruction-panel">
            <h3>Instructions</h3>
            
            <div class="info-box">
                <h4 style="margin-top: 0; margin-bottom: 5px;">Yeast Information</h4>
                <p style="margin-bottom: 5px;" id="yeastInfoType">Your recipe uses Fresh Yeast.</p>
                <ul class="info-list">
                    <li><strong>Fresh yeast</strong>: Use directly. Crumble into flour or dissolve in liquid.</li>
                    <li><strong>Instant dry yeast</strong>: Mix into dry ingredients. Use ~33% of fresh amount.</li>
                    <li><strong>Active dry yeast</strong>: Rehydrate in warm water (40-43°C) for 5-10 minutes. Use ~50% of fresh amount.</li>
                </ul>
            </div>
            
            <div class="info-box">
                <h4 style="margin-top: 0; margin-bottom: 5px;">Lamination Notes</h4>
                <ul class="info-list">
                    <li><strong>French Lock-in</strong>: Dough-butter-dough (3 layers).</li>
                    <li><strong>Single</strong>: 5 layers after French, then ~2x prior layers.</li>
                    <li><strong>Letter</strong>: 7 layers after French, then ~3x prior layers.</li>
                    <li><strong>Book</strong>: 9 layers after French, then ~4x prior layers.</li>
                    <li>Total folds: 2-4 (French + 1-3 more). Typical layers: Croissants (27-81), Danish/Pain au Chocolat (9-27).</li>
                </ul>
            </div>
            
            <ol id="instructionsList"></ol>
        </div>
    </div>

    <script>
        let state = {
            pastryCount: 12,
            pastryWeight: 80,
            hydration: 54,
            usePoolish: false,
            cutoffsWeight: 0,
            salt: 2,
            sugar: 10,
            butter: 9,
            yeastType: 'fresh',
            yeast: 3,
            laminationButter: 33,
            fold1: 'letter',
            fold2: 'none',
            fold3: 'none',
            flour: 0,
            water: 0,
            saltWeight: 0,
            sugarWeight: 0,
            butterWeight: 0,
            yeastWeight: 0,
            poolishFlour: 0,
            poolishWater: 0,
            poolishYeast: 0,
            laminationButterWeight: 0,
            totalDoughWeight: 0,
            totalLayers: 0,
            shape: 'triangle',
            thickness: 4,
            length: 25,
            width: 9,
            rawMass: 0,
            bakedMass: 0,
            density: 0,
            flourCost: 0.50,
            waterCost: 0.00,
            saltCost: 0.40,
            sugarCost: 0.80,
            butterCost: 3.50,
            yeastCost: 1.60,
            totalCost: 0,
            coreCost: 0,
            otherIngredientsCost: 0,
            costPerPastry: 0,
            otherIngredients: [],
            useMassCalculator: true
        };

        const elements = {
            pastryCount: document.getElementById('pastryCount'),
            pastryWeight: document.getElementById('pastryWeight'),
            useMassCalculator: document.getElementById('useMassCalculator'),
            hydration: document.getElementById('hydration'),
            hydrationValue: document.getElementById('hydrationValue'),
            usePoolish: document.getElementById('usePoolish'),
            cutoffsWeight: document.getElementById('cutoffsWeight'),
            salt: document.getElementById('salt'),
            saltValue: document.getElementById('saltValue'),
            sugar: document.getElementById('sugar'),
            sugarValue: document.getElementById('sugarValue'),
            butter: document.getElementById('butter'),
            butterValue: document.getElementById('butterValue'),
            yeastType: document.getElementsByName('yeastType'),
            yeast: document.getElementById('yeast'),
            yeastValue: document.getElementById('yeastValue'),
            yeastTypeLabel: document.getElementById('yeastTypeLabel'),
            yeastEquivalent: document.getElementById('yeastEquivalent'),
            laminationButter: document.getElementById('laminationButter'),
            laminationButterValue: document.getElementById('laminationButterValue'),
            fold1: document.getElementById('fold1'),
            fold2: document.getElementById('fold2'),
            fold3: document.getElementById('fold3'),
            flourAmount: document.getElementById('flourAmount'),
            waterAmount: document.getElementById('waterAmount'),
            saltAmount: document.getElementById('saltAmount'),
            sugarAmount: document.getElementById('sugarAmount'),
            butterAmount: document.getElementById('butterAmount'),
            yeastTypeDisplay: document.getElementById('yeastTypeDisplay'),
            yeastAmount: document.getElementById('yeastAmount'),
            cutoffsRow: document.getElementById('cutoffsRow'),
            cutoffsAmount: document.getElementById('cutoffsAmount'),
            poolishSection: document.getElementById('poolishSection'),
            poolishFlourAmount: document.getElementById('poolishFlourAmount'),
            poolishWaterAmount: document.getElementById('poolishWaterAmount'),
            poolishYeastTypeDisplay: document.getElementById('poolishYeastTypeDisplay'),
            poolishYeastAmount: document.getElementById('poolishYeastAmount'),
            precisionScaleWarning: document.getElementById('precisionScaleWarning'),
            laminationButterAmount: document.getElementById('laminationButterAmount'),
            totalLayers: document.getElementById('totalLayers'),
            layerVisualization: document.getElementById('layerVisualization'),
            totalDoughWeight: document.getElementById('totalDoughWeight'),
            finalWeight: document.getElementById('finalWeight'),
            totalCost: document.getElementById('totalCost'),
            costPerPastry: document.getElementById('costPerPastry'),
            pastrySummary: document.getElementById('pastrySummary'),
            yeastInfoType: document.getElementById('yeastInfoType'),
            instructionsList: document.getElementById('instructionsList'),
            shape: document.getElementsByName('shape'),
            thickness: document.getElementById('thickness'),
            thicknessValue: document.getElementById('thicknessValue'),
            length: document.getElementById('length'),
            lengthValue: document.getElementById('lengthValue'),
            width: document.getElementById('width'),
            widthValue: document.getElementById('widthValue'),
            rawMass: document.getElementById('rawMass'),
            bakedMass: document.getElementById('bakedMass'),
            density: document.getElementById('density'),
            flourCost: document.getElementById('flourCost'),
            waterCost: document.getElementById('waterCost'),
            saltCost: document.getElementById('saltCost'),
            sugarCost: document.getElementById('sugarCost'),
            butterCost: document.getElementById('butterCost'),
            yeastCost: document.getElementById('yeastCost'),
            otherIngredients: document.getElementById('otherIngredients'),
            addOther: document.getElementById('addOther'),
            coreCost: document.getElementById('coreCost'),
            otherIngredientsCost: document.getElementById('otherIngredientsCost'),
            totalCostLocal: document.getElementById('totalCostLocal')
        };

        function saveState() {
            localStorage.setItem('viennoiserieCalculatorState', JSON.stringify(state));
        }

        function loadState() {
            const savedState = localStorage.getItem('viennoiserieCalculatorState');
            if (savedState) {
                state = JSON.parse(savedState);
                applyStateToInputs();
            }
        }

        function applyStateToInputs() {
            elements.pastryCount.value = state.pastryCount;
            elements.pastryWeight.value = state.pastryWeight;
            elements.useMassCalculator.checked = state.useMassCalculator;
            elements.hydration.value = state.hydration;
            elements.hydrationValue.textContent = state.hydration;
            elements.usePoolish.checked = state.usePoolish;
            elements.cutoffsWeight.value = state.cutoffsWeight;
            elements.salt.value = state.salt;
            elements.saltValue.textContent = state.salt;
            elements.sugar.value = state.sugar;
            elements.sugarValue.textContent = state.sugar;
            elements.butter.value = state.butter;
            elements.butterValue.textContent = state.butter;
            elements.yeast.value = state.yeast;
            elements.yeastValue.textContent = state.yeast;
            elements.yeastTypeLabel.textContent = getYeastTypeLabel();
            elements.laminationButter.value = state.laminationButter;
            elements.laminationButterValue.textContent = state.laminationButter;
            elements.fold1.value = state.fold1;
            elements.fold2.value = state.fold2;
            elements.fold3.value = state.fold3;
            elements.thickness.value = state.thickness;
            elements.thicknessValue.textContent = state.thickness;
            elements.length.value = state.length;
            elements.lengthValue.textContent = state.length;
            elements.width.value = state.width;
            elements.widthValue.textContent = state.width;
            elements.flourCost.value = state.flourCost;
            elements.waterCost.value = state.waterCost;
            elements.saltCost.value = state.saltCost;
            elements.sugarCost.value = state.sugarCost;
            elements.butterCost.value = state.butterCost;
            elements.yeastCost.value = state.yeastCost;

            elements.yeastType.forEach(radio => {
                radio.checked = radio.value === state.yeastType;
            });
            elements.shape.forEach(radio => {
                radio.checked = radio.value === state.shape;
            });

            updateYeastRangeInput();
            updateYeastEquivalent();

            elements.otherIngredients.innerHTML = '';
            state.otherIngredients.forEach(ingredient => addOtherIngredient(ingredient.name, ingredient.quantity, ingredient.cost));
        }

        function initializeListeners() {
            elements.pastryCount.addEventListener('input', () => updateState('pastryCount', Math.max(1, parseInt(elements.pastryCount.value) || 1)));
            elements.pastryWeight.addEventListener('input', () => {
                if (!state.useMassCalculator) updateState('pastryWeight', Math.max(20, parseInt(elements.pastryWeight.value) || 20));
            });
            elements.useMassCalculator.addEventListener('change', () => {
                updateState('useMassCalculator', elements.useMassCalculator.checked);
                elements.pastryWeight.disabled = state.useMassCalculator;
            });
            elements.cutoffsWeight.addEventListener('input', () => updateState('cutoffsWeight', Math.max(0, parseInt(elements.cutoffsWeight.value) || 0)));
            elements.hydration.addEventListener('input', () => {
                updateState('hydration', parseInt(elements.hydration.value));
                elements.hydrationValue.textContent = elements.hydration.value;
            });
            elements.salt.addEventListener('input', () => {
                updateState('salt', parseFloat(elements.salt.value));
                elements.saltValue.textContent = elements.salt.value;
            });
            elements.sugar.addEventListener('input', () => {
                updateState('sugar', parseInt(elements.sugar.value));
                elements.sugarValue.textContent = elements.sugar.value;
            });
            elements.butter.addEventListener('input', () => {
                updateState('butter', parseInt(elements.butter.value));
                elements.butterValue.textContent = elements.butter.value;
            });
            elements.yeast.addEventListener('input', () => {
                updateState('yeast', parseFloat(elements.yeast.value));
                elements.yeastValue.textContent = state.yeast;
                updateYeastEquivalent();
            });
            elements.laminationButter.addEventListener('input', () => {
                updateState('laminationButter', parseInt(elements.laminationButter.value));
                elements.laminationButterValue.textContent = elements.laminationButter.value;
            });
            elements.fold1.addEventListener('change', () => updateState('fold1', elements.fold1.value));
            elements.fold2.addEventListener('change', () => updateState('fold2', elements.fold2.value));
            elements.fold3.addEventListener('change', () => updateState('fold3', elements.fold3.value));
            elements.usePoolish.addEventListener('change', () => updateState('usePoolish', elements.usePoolish.checked));
            elements.yeastType.forEach(radio => {
                radio.addEventListener('change', () => {
                    if (radio.checked) handleYeastTypeChange(radio.value);
                });
            });

            elements.shape.forEach(radio => {
                radio.addEventListener('change', () => {
                    if (radio.checked) updateState('shape', radio.value);
                });
            });
            elements.thickness.addEventListener('input', () => {
                updateState('thickness', parseFloat(elements.thickness.value));
                elements.thicknessValue.textContent = elements.thickness.value;
            });
            elements.length.addEventListener('input', () => {
                updateState('length', parseInt(elements.length.value));
                elements.lengthValue.textContent = elements.length.value;
            });
            elements.width.addEventListener('input', () => {
                updateState('width', parseFloat(elements.width.value));
                elements.widthValue.textContent = elements.width.value;
            });

            elements.flourCost.addEventListener('input', () => updateState('flourCost', Math.max(0, parseFloat(elements.flourCost.value) || 0)));
            elements.waterCost.addEventListener('input', () => updateState('waterCost', Math.max(0, parseFloat(elements.waterCost.value) || 0)));
            elements.saltCost.addEventListener('input', () => updateState('saltCost', Math.max(0, parseFloat(elements.saltCost.value) || 0)));
            elements.sugarCost.addEventListener('input', () => updateState('sugarCost', Math.max(0, parseFloat(elements.sugarCost.value) || 0)));
            elements.butterCost.addEventListener('input', () => updateState('butterCost', Math.max(0, parseFloat(elements.butterCost.value) || 0)));
            elements.yeastCost.addEventListener('input', () => updateState('yeastCost', Math.max(0, parseFloat(elements.yeastCost.value) || 0)));

            elements.addOther.addEventListener('click', () => addOtherIngredient());
        }

        function addOtherIngredient(name = '', quantity = 0, cost = 0) {
            const index = state.otherIngredients.length;
            state.otherIngredients.push({ name, quantity, cost });

            const div = document.createElement('div');
            div.className = 'other-ingredient';
            div.innerHTML = `
                <input type="text" placeholder="e.g., Chocolate" value="${name}">
                <input type="number" placeholder="g" min="0" step="1" value="${quantity}">
                <input type="number" placeholder="£/kg" min="0" step="0.01" value="${cost}">
                <button>Remove</button>
            `;
            elements.otherIngredients.appendChild(div);

            const inputs = div.querySelectorAll('input');
            inputs[0].addEventListener('input', (e) => {
                state.otherIngredients[index].name = e.target.value;
                calculate();
                render();
                saveState();
            });
            inputs[1].addEventListener('input', (e) => {
                state.otherIngredients[index].quantity = Math.max(0, parseFloat(e.target.value) || 0);
                calculate();
                render();
                saveState();
            });
            inputs[2].addEventListener('input', (e) => {
                state.otherIngredients[index].cost = Math.max(0, parseFloat(e.target.value) || 0);
                calculate();
                render();
                saveState();
            });

            div.querySelector('button').addEventListener('click', () => {
                state.otherIngredients.splice(index, 1);
                div.remove();
                calculate();
                render();
                saveState();
            });

            calculate();
            render();
            saveState();
        }

        function updateState(key, value) {
            state[key] = value;
            const foldCount = getFoldCount();
            if (foldCount > 4) {
                if (key === 'fold3') elements.fold3.value = 'none';
                else if (key === 'fold2') elements.fold2.value = 'none';
                else if (key === 'fold1') elements.fold1.value = 'none';
                state[key] = 'none';
            }
            calculate();
            render();
            saveState();
        }

        function handleYeastTypeChange(newType) {
            if (newType === state.yeastType) return;
            let freshEquivalent = state.yeast;
            if (state.yeastType === 'instant') freshEquivalent = state.yeast / 0.33;
            else if (state.yeastType === 'active') freshEquivalent = state.yeast / 0.5;
            let newYeastPercentage = newType === 'fresh' ? freshEquivalent :
                                   newType === 'instant' ? freshEquivalent * 0.33 :
                                   freshEquivalent * 0.5;
            state.yeastType = newType;
            state.yeast = Math.round(newYeastPercentage * 10) / 10;
            updateYeastRangeInput();
            elements.yeastValue.textContent = state.yeast;
            elements.yeast.value = state.yeast;
            updateYeastEquivalent();
            elements.yeastTypeLabel.textContent = getYeastTypeLabel();
            calculate();
            render();
            saveState();
        }

        function updateYeastRangeInput() {
            if (state.yeastType === 'fresh') {
                elements.yeast.min = 1; elements.yeast.max = 5; elements.yeast.step = 0.1;
            } else if (state.yeastType === 'instant') {
                elements.yeast.min = 0.3; elements.yeast.max = 1.7; elements.yeast.step = 0.05;
            } else if (state.yeastType === 'active') {
                elements.yeast.min = 0.5; elements.yeast.max = 2.5; elements.yeast.step = 0.05;
            }
        }

        function updateYeastEquivalent() {
            let equivalentText = "";
            if (state.yeastType === 'fresh') {
                const instantEquiv = (state.yeast * 0.33).toFixed(2);
                const activeEquiv = (state.yeast * 0.5).toFixed(2);
                equivalentText = `(Equivalent to ${instantEquiv}% instant or ${activeEquiv}% active dry)`;
            } else if (state.yeastType === 'instant') {
                const freshEquiv = (state.yeast / 0.33).toFixed(1);
                equivalentText = `(Equivalent to ${freshEquiv}% fresh yeast)`;
            } else if (state.yeastType === 'active') {
                const freshEquiv = (state.yeast / 0.5).toFixed(1);
                equivalentText = `(Equivalent to ${freshEquiv}% fresh yeast)`;
            }
            elements.yeastEquivalent.textContent = equivalentText;
        }

        function getYeastTypeLabel() {
            return { 'fresh': 'Fresh', 'instant': 'Instant Dry', 'active': 'Active Dry' }[state.yeastType] || 'Yeast';
        }

        function getFoldCount() {
            let count = 1; // French lock-in fold
            if (state.fold1 !== 'none') count++;
            if (state.fold2 !== 'none') count++;
            if (state.fold3 !== 'none') count++;
            return count;
        }

        function calculate() {
            const targetWeight = state.pastryCount * state.pastryWeight - state.cutoffsWeight;
            const totalPercentage = 100 + state.hydration + state.salt + state.sugar + state.butter + state.yeast;
            const totalFlourNeeded = (targetWeight * 100) / totalPercentage;
            
            let poolishFlourAmount = 0, poolishWaterAmount = 0, poolishYeastAmount = 0;
            if (state.usePoolish) {
                poolishFlourAmount = totalFlourNeeded * 0.15;
                poolishWaterAmount = poolishFlourAmount;
                const poolishYeastPercent = state.yeastType === 'fresh' ? 1.0 : 
                                          state.yeastType === 'instant' ? 0.33 : 0.5;
                poolishYeastAmount = poolishFlourAmount * (poolishYeastPercent/100);
            }
            
            const mainFlour = totalFlourNeeded - (state.usePoolish ? poolishFlourAmount : 0);
            const waterAmount = (totalFlourNeeded * (state.hydration/100)) - (state.usePoolish ? poolishWaterAmount : 0);
            const saltAmount = totalFlourNeeded * (state.salt/100);
            const sugarAmount = totalFlourNeeded * (state.sugar/100);
            const butterAmount = totalFlourNeeded * (state.butter/100);
            const yeastAmount = totalFlourNeeded * (state.yeast/100) - (state.usePoolish ? poolishYeastAmount : 0);
            
            const totalWeight = mainFlour + waterAmount + saltAmount + sugarAmount + 
                              butterAmount + yeastAmount + 
                              (state.usePoolish ? (poolishFlourAmount + poolishWaterAmount + poolishYeastAmount) : 0) + 
                              state.cutoffsWeight;
            
            const laminationButterAmount = totalWeight * (state.laminationButter/100);
            let totalLayers = 3; // French lock-in (D-B-D)
            const folds = [state.fold1, state.fold2, state.fold3];
            folds.forEach(fold => {
                if (fold === 'single') totalLayers = totalLayers === 3 ? 5 : (totalLayers * 2) - 1;
                else if (fold === 'letter') totalLayers = totalLayers === 3 ? 7 : (totalLayers * 3) - 2;
                else if (fold === 'book') totalLayers = totalLayers === 3 ? 9 : (totalLayers * 4) - 3;
            });
            
            state.flour = Math.round(mainFlour);
            state.water = Math.round(waterAmount);
            state.saltWeight = Math.round(saltAmount * 10) / 10;
            state.sugarWeight = Math.round(sugarAmount);
            state.butterWeight = Math.round(butterAmount);
            state.yeastWeight = Math.round(yeastAmount * 10) / 10;
            state.poolishFlour = Math.round(poolishFlourAmount);
            state.poolishWater = Math.round(poolishWaterAmount);
            state.poolishYeast = poolishYeastAmount < 1 ? 
                               Math.round(poolishYeastAmount * 100) / 100 : 
                               Math.round(poolishYeastAmount * 10) / 10;
            state.laminationButterWeight = Math.round(laminationButterAmount);
            state.totalDoughWeight = Math.round(totalWeight);
            state.totalLayers = totalLayers;

            const baseDensity = 1.18;
            const hydrationFactor = (state.hydration - 50) * -0.002;
            const doughButterFactor = (state.butter / 100) * (1.18 - 0.9);
            const laminationButterFactor = (state.laminationButter / 100) * (1.18 - 0.9);
            const density = baseDensity - doughButterFactor - laminationButterFactor + hydrationFactor;
            state.density = Math.round(density * 100) / 100;

            const thicknessCm = state.thickness / 10;
            let volume = 0;
            if (state.shape === 'triangle') {
                volume = (state.length * state.width * thicknessCm) / 2;
            } else {
                volume = state.length * state.width * thicknessCm;
            }
            const rawMass = volume * state.density;
            const bakedMass = rawMass * (1 - 0.12);
            state.rawMass = Math.round(rawMass * 10) / 10;
            state.bakedMass = Math.round(bakedMass * 10) / 10;

            if (state.useMassCalculator) {
                state.pastryWeight = Math.round(state.rawMass);
                elements.pastryWeight.value = state.pastryWeight;
            }

            const flourTotalCost = (state.flour + state.poolishFlour) / 1000 * state.flourCost;
            const waterTotalCost = (state.water + state.poolishWater) / 1000 * state.waterCost;
            const saltTotalCost = state.saltWeight / 1000 * state.saltCost;
            const sugarTotalCost = state.sugarWeight / 1000 * state.sugarCost;
            const butterTotalCost = (state.butterWeight + state.laminationButterWeight) / 1000 * state.butterCost;
            const yeastTotalCost = (state.yeastWeight + state.poolishYeast) / 1000 * state.yeastCost;
            const otherTotalCost = state.otherIngredients.reduce((sum, item) => sum + (item.quantity / 1000 * item.cost), 0);

            state.coreCost = flourTotalCost + waterTotalCost + saltTotalCost + sugarTotalCost + butterTotalCost + yeastTotalCost;
            state.otherIngredientsCost = otherTotalCost;
            state.totalCost = state.coreCost + state.otherIngredientsCost;
            state.costPerPastry = state.totalCost / state.pastryCount;
        }

        function render() {
            elements.flourAmount.textContent = `${state.flour} g`;
            elements.waterAmount.textContent = `${state.water} g`;
            elements.saltAmount.textContent = `${state.saltWeight} g`;
            elements.sugarAmount.textContent = `${state.sugarWeight} g`;
            elements.butterAmount.textContent = `${state.butterWeight} g`;
            elements.yeastTypeDisplay.textContent = `${getYeastTypeLabel()} Yeast`;
            elements.yeastAmount.textContent = `${state.yeastWeight} g`;
            
            elements.cutoffsRow.style.display = state.cutoffsWeight > 0 ? '' : 'none';
            if (state.cutoffsWeight > 0) elements.cutoffsAmount.textContent = `${state.cutoffsWeight} g`;
            
            elements.poolishSection.style.display = state.usePoolish ? '' : 'none';
            if (state.usePoolish) {
                elements.poolishFlourAmount.textContent = `${state.poolishFlour} g`;
                elements.poolishWaterAmount.textContent = `${state.poolishWater} g`;
                elements.poolishYeastTypeDisplay.textContent = `${getYeastTypeLabel()} Yeast`;
                elements.poolishYeastAmount.textContent = `${state.poolishYeast} g`;
                elements.precisionScaleWarning.style.display = state.poolishYeast < 0.1 ? '' : 'none';
            }
            
            elements.laminationButterAmount.textContent = `${state.laminationButterWeight} g`;
            elements.totalLayers.textContent = `${state.totalLayers}`;
            elements.totalDoughWeight.textContent = `${state.totalDoughWeight} g`;
            elements.finalWeight.textContent = `${state.totalDoughWeight + state.laminationButterWeight} g`;
            elements.totalCost.textContent = `£${state.totalCost.toFixed(2)}`;
            elements.costPerPastry.textContent = `£${state.costPerPastry.toFixed(2)}`;
            elements.pastrySummary.textContent = `${state.pastryCount} × ${state.pastryWeight}g each`;
            elements.yeastInfoType.textContent = `Your recipe uses ${getYeastTypeLabel()} Yeast.`;
            
            elements.pastryWeight.disabled = state.useMassCalculator;

            elements.coreCost.textContent = `£${state.coreCost.toFixed(2)}`;
            elements.otherIngredientsCost.textContent = `£${state.otherIngredientsCost.toFixed(2)}`;
            elements.totalCostLocal.textContent = `£${state.totalCost.toFixed(2)}`;

            updateInstructions();
            drawLayerVisualization();

            elements.rawMass.textContent = `${state.rawMass} g`;
            elements.bakedMass.textContent = `${state.bakedMass} g`;
            elements.density.textContent = `${state.density} g/cm³`;
        }

        function updateInstructions() {
            const instructions = [];
            if (state.usePoolish) {
                let poolishInstruction = `<strong>Prepare poolish:</strong> Mix ${state.poolishFlour}g flour, ${state.poolishWater}g water, and ${state.poolishYeast}g ${getYeastTypeLabel().toLowerCase()} yeast`;
                if (state.yeastType === 'active') poolishInstruction += ` (rehydrate first in a small amount of the water)`;
                poolishInstruction += `. Ferment at room temperature for 12-16 hours until bubbly.`;
                instructions.push(poolishInstruction);
            }
            
            let doughInstruction = `<strong>Mix dough:</strong> Combine ${state.flour}g flour, ${state.water}g water`;
            if (state.usePoolish) doughInstruction += `, poolish`;
            doughInstruction += `, ${state.saltWeight}g salt, ${state.sugarWeight}g sugar, and ${state.yeastWeight}g `;
            if (state.yeastType === 'active') doughInstruction += `rehydrated `;
            doughInstruction += `${state.yeastType} yeast`;
            if (state.yeastType === 'active' && !state.usePoolish) doughInstruction += ` (rehydrate in a small amount of warm water first)`;
            doughInstruction += `. Mix until partially developed, then add ${state.butterWeight}g butter`;
            if (state.cutoffsWeight > 0) doughInstruction += ` and ${state.cutoffsWeight}g cutoffs`;
            doughInstruction += `, kneading until smooth.`;
            instructions.push(doughInstruction);
            
            instructions.push(`<strong>Bulk fermentation:</strong> Let dough rise at room temperature until doubled, about 1.5-2 hours, with optional folds for strength.`);
            
            let laminationInstruction = `<strong>Lamination:</strong> Roll dough into a rectangle and lock in ${state.laminationButterWeight}g butter with a French fold`;
            const folds = [state.fold1, state.fold2, state.fold3].filter(f => f !== 'none');
            if (folds.length > 0) {
                laminationInstruction += `, followed by ${folds.map(f => f).join(', ')} fold${folds.length > 1 ? 's' : ''}`;
            }
            laminationInstruction += ` (total ${state.totalLayers} layers). Chill 20-30 minutes between folds as needed.`;
            instructions.push(laminationInstruction);
            
            instructions.push(`<strong>Shape:</strong> Roll dough to desired thickness (typically 3-5mm) and cut/shape into ${state.pastryCount} pieces.`);
            instructions.push(`<strong>Final proof:</strong> Proof at 24-26°C (75-78°F) until doubled and jiggly, about 2-3 hours.`);
            instructions.push(`<strong>Bake:</strong> Optionally brush with egg wash (1 egg + 1 tbsp water). Bake at 190-200°C (375-390°F) for 15-20 minutes until golden brown.`);

            elements.instructionsList.innerHTML = instructions.map(i => `<li>${i}</li>`).join('');
        }

        function drawLayerVisualization() {
            const canvas = elements.layerVisualization;
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            ctx.clearRect(0, 0, width, height);
            
            let totalLayers = 3;
            const folds = [state.fold1, state.fold2, state.fold3];
            folds.forEach(fold => {
                if (fold === 'single') totalLayers = totalLayers === 3 ? 5 : (totalLayers * 2) - 1;
                else if (fold === 'letter') totalLayers = totalLayers === 3 ? 7 : (totalLayers * 3) - 2;
                else if (fold === 'book') totalLayers = totalLayers === 3 ? 9 : (totalLayers * 4) - 3;
            });
            
            const layers = [];
            for (let i = 0; i < totalLayers; i++) {
                layers.push(i % 2 === 0 ? 'dough' : 'butter');
            }
            
            const layerHeight = Math.min(height / totalLayers, 10);
            layers.slice(0, Math.min(totalLayers, height / layerHeight)).forEach((layer, i) => {
                ctx.fillStyle = layer === 'dough' ? '#ffffff' : '#ffeb3b';
                ctx.fillRect(0, i * layerHeight, width, layerHeight);
                ctx.strokeStyle = '#ccc';
                ctx.strokeRect(0, i * layerHeight, width, layerHeight);
            });
        }

        function init() {
            loadState();
            initializeListeners();
            calculate();
            render();
        }

        init();
    </script>
</body>
</html>
